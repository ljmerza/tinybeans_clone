# Story 1.2: Onboarding Flow for New Invitees

## Status
- Ready for Review

## Story
**As a** user invited without an account,  
**I want** a guided onboarding path that honors existing auth options,  
**so that** I can join a circle securely and finish setup without friction.

## Acceptance Criteria
1. New invite flow generates onboarding tokens tied to invitation metadata with expiration management.  
2. Magic link, Google OAuth, and 2FA enrollment steps integrate seamlessly before circle membership is finalized.  
3. Invite status transitions to “accepted” only after the onboarding/auth journey completes (same rule as existing users).  
4. Notification templates for onboarding and reminders queue through existing Celery workers.

## Tasks / Subtasks
- [x] Extend invitation acceptance endpoints to branch new-account onboarding flows (AC 1, AC 3)  
- [x] Generate onboarding tokens via `mysite/auth/token_utils.py` with explicit scopes/TTL (AC 1)  
- [x] Integrate onboarding flow with magic link, Google OAuth, and 2FA services (`mysite/auth`) (AC 2)  
  - [x] Ensure membership creation happens only after auth completion (AC 2, AC 3)  
- [x] Update Celery tasks and templates to handle onboarding/ reminder messaging (AC 4)  
- [x] Add pytest coverage for onboarding acceptance, token expiry, and notification dispatch (All ACs)

## Dev Notes
- Auth services reside in `mysite/auth/` (magic links in `views.py`, Google OAuth in `views_google_oauth.py`, 2FA services in `services/twofa_service.py`). Reuse these utilities instead of duplicating logic.  
- Invitation acceptance currently lives in `mysite/circles/views/invitations.py`; augment to create onboarding tokens and call auth workflows.  
- Token storage uses Redis; align new onboarding TTL with invite expiry to avoid dangling tokens.  
- Celery tasks for email live in `mysite/emails/tasks.py` and `mysite/circles/tasks.py`; `send_circle_invitation_reminders` handles reminder scheduling (Mailpit for dev).  
- Consider idempotency: multiple clicks should be safe and not create duplicate memberships.  
- Document new env variables (token TTL, reminder cadence) in `.env.example` and `DEVELOPMENT.md`.

### Testing
- Backend tests in `mysite/users/tests/` and `mysite/auth/tests/` covering onboarding tokens, acceptance flow, and 2FA enforcement.  
- Use pytest with `mysite.test_settings`; mock external providers (Google, Twilio) appropriately.  
- Validate Celery tasks using `celery.app.task` testing patterns and ensuring email context renders.  
- Include regression test ensuring existing invite acceptance for already registered users remains intact.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-02-14 | 0.1 | Initial draft | BMad Master |
| 2025-02-14 | 0.2 | Backend onboarding flow started | Codex |
| 2025-02-18 | 1.0 | Onboarding token issuance/finalization flow implemented | Codex |

## Dev Agent Record
- **Agent**: James (Codex)
- **Summary**: Completed invitation onboarding endpoints, token storage TTL controls, and Celery reminder integration while ensuring membership creation only occurs post-auth flow.
- **Tests**:
  - `python manage.py test mysite.users.tests.test_invitation_roles --settings=mysite.test_settings`
  - `python manage.py test mysite.users.tests.test_onboarding_views --settings=mysite.test_settings`

## QA Results
*(To be completed by QA agent.)*
