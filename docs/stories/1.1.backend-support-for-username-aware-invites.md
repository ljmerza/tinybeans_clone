# Story 1.1: Backend Support for Username-Aware Invites

## Status
- InProgress

## Story
**As a** circle admin,  
**I want** to invite members by username or email with clear feedback,  
**so that** I can quickly add existing community members without guesswork.

## Acceptance Criteria
1. API accepts either username or email and indicates whether the target user already exists.  
2. Invites always persist as pending until recipients explicitly accept; membership links are created only after acceptance.  
3. API responses include structured status codes/messages surfaced by drf-spectacular schema updates.  
4. Rate limiting guards against invite spam per admin and per circle, configurable via settings.

## Tasks / Subtasks
- [ ] Update invitation serializers to handle dual input modes (AC 1)  
  - [ ] Add validation for username/email lookup with clear response messaging (AC 1, AC 3)  
- [ ] Extend `CircleInvitationCreateView` (and related endpoints) to support username flow while keeping legacy behavior (AC 1, AC 2)  
  - [ ] Ensure invitations remain pending and membership creation moves to acceptance flow (AC 2)  
- [ ] Introduce rate limiting configuration and enforce per admin/circle limits (AC 4)  
- [ ] Document new response schema via drf-spectacular annotations and update tests (AC 3)  
- [ ] Add/extend pytest coverage for new invite pathways and rate limiting (All ACs)

## Dev Notes
- Backend lives in `mysite/`; circle logic is in `mysite/users` (models/serializers/views/tasks). See `docs/brownfield-architecture.md` System Snapshot and Circles Domain sections.  
- `CircleInvitation` models reside in `mysite/users/models/circle.py`; invitations currently email-only. Extend metadata as needed with Django migrations.  
- API surface: `mysite/users/views/circles.py` handles invite endpoints; serializers in `mysite/users/serializers/`.  
- Token flow uses Redis via `mysite/auth/token_utils.py` (tokens issued with TTL). Ensure new invites use this and remain pending until acceptance.  
- Rate limiting toggled via env variables (`RATELIMIT_ENABLE`, etc.) referenced in settings; add new limits and document defaults in `.env.example`.  
- Remember to update drf-spectacular schema annotations so frontend sees new fields automatically.  
- Maintain backward compatibility for existing clients hitting email-only endpoint; consider feature flag if needed.

### Testing
- Use pytest with `python manage.py test --settings=mysite.test_settings` or `pytest`.  
- Place backend tests in `mysite/users/tests/` (e.g., `test_circles.py`).  
- Write tests covering username lookup success/failure, pending state enforcement, rate-limited responses, and schema compliance.  
- Mock Redis token store where needed; sanitize Celery task assertions.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-02-14 | 0.1 | Initial draft | BMad Master |
| 2025-02-14 | 0.2 | Implementation kickoff | Codex |

## Dev Agent Record
*(To be completed by development agent.)*

## QA Results
*(To be completed by QA agent.)*
